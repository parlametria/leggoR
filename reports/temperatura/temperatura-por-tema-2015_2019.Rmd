---
title: "Análise da Temperatura por Tema"
author: "Equipe Leg.go"
date: "25/05/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---

Neste relatório, faremos uma análise histórica da Temperatura das proposições agregadas por tema ao longo dos anos.

```{r knitr_init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE, results="asis"}
library(dplyr)
library(magrittr)
library(ggplot2)
library(plotly)

knitr::opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)

min_date <- lubridate::ymd_hms('2015-01-01 00:00:00')
max_date <- lubridate::ymd_hms('2019-05-10 23:59:59')

temperatura_props <- readr::read_csv('../../data/novo_historico_temperatura.csv')
leggo_ids <- readr::read_csv('../../data/leggo_ids.csv')
proposicoes <- readr::read_csv('../../data/proposicoes.csv')

nomes_pls <- proposicoes %>% 
  mutate(nome_pl = paste(sigla_tipo, paste(numero, lubridate::year(data_apresentacao),sep='/'))) %>%
  select(id_ext, nome_pl)

leggo_ids_nomes <- leggo_ids %>%
  inner_join(nomes_pls) %>%
  select(id_leggo, id_ext, nome_pl, everything()) %>%
  group_by(id_leggo) %>%
  summarise(id_ext = paste0(id_ext, collapse = "|"),
            nome_pl = paste0(nome_pl, collapse = "|"),
            apelido = first(apelido),
            tema = first(tema))
  
temperatura_props_temas <- temperatura_props %>%
  filter((periodo >= min_date) & (periodo <= max_date)) %>%
  inner_join(leggo_ids_nomes,by = "id_leggo") %>%
  tidyr::separate_rows(tema,sep=';') %>%
  select(id_leggo, tema, nome_pl, apelido, semana = periodo, temperatura_periodo, temperatura_recente) %>%
  arrange(semana,tema,desc(temperatura_recente))

evolucao_semanal_temperatura <- temperatura_props_temas %>%
  group_by(id_leggo) %>%
  arrange(semana) %>%
  mutate(evolucao_temp_recente = temperatura_recente - lag(temperatura_recente, default = 0)) %>%
  ungroup() %>%
  arrange(id_leggo,semana)

temperatura_temas <- temperatura_props_temas %>%
  group_by(tema,semana) %>%
  summarise(num_obs = n(),
            total_temp = sum(temperatura_recente),
            min_temp = min(temperatura_recente),
            max_temp = max(temperatura_recente),
            mean_temp = mean(temperatura_recente),
            median_temp = median(temperatura_recente),
            std_temp = sd(temperatura_recente),
            var_temp = var(temperatura_recente))

cor_agenda_nacional <- "#F5E4A3"
cor_direitos_humanos <- "#90A4C5"
cor_educacao <-"#F28BB9"
cor_integridade_transparencia <- "#75E4CD"
cor_meio_ambiente <- "#9A7891"
```

## Qual foi o comportamento da temperatura geral das proposições acompanhadas pelo Leggo nos últimos anos (2015-2019)?

```{r fig.width=12}

temperatura_geral <- temperatura_props %>%
  filter((periodo >= min_date) & (periodo <= max_date)) %>%
  inner_join(leggo_ids,by = "id_leggo") %>%
  mutate(semana = periodo) %>%
  group_by(semana) %>%
  summarise(total_temp = sum(temperatura_recente))

p <- temperatura_geral %>%
  filter((semana >= lubridate::ymd_hms('2015-01-01 00:00:00')) && (semana <= lubridate::ymd_hms('2018-12-31 23:59:59'))) %>%
  ggplot(aes(x=as.Date(semana), y=total_temp)) +
  geom_col(position="dodge", fill="#dc6060") +
  xlab("Tempo") + 
  ylab("Temperatura") +
  scale_x_date(date_labels = "%d-%m-%Y") +
  theme_minimal() + 
  theme(legend.title = element_blank())

ggplotly(p)

```

Como podemos perceber, para o nosso sub-conjunto de proposições, a temperatura estava mais baixa em 2015 e 2016, apresentando uma aumento do final de 2016 para o início de 2017. 
Em seguida, houve uma queda e voltou a subir no primeiro semestre de 2018.
No período anterior e durante as eleições houve uma (natural) queda e vem subindo do final do ano de 2018 até o presente momento (Maio/2019).
Obs: Os espaços em branco no gráfico são períodos de recesso parlamentar.

Vamos analisar a temperatura por tema para podermos compreender melhor que temas/proposições influcenciaram essas subidas de temperatura observadas.

## Qual foi o comportamento da temperatura de cada tema acompanhado pelo Leggo nos últimos anos (2015-2019)? 

```{r, fig.width=12}
p <- temperatura_temas %>% 
  filter((semana >= lubridate::ymd_hms('2015-01-01 00:00:00')) && (semana <= lubridate::ymd_hms('2018-12-31 23:59:59'))) %>%
  ggplot(aes(x=as.Date(semana), y=total_temp, fill=tema)) +
  geom_area() +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  facet_wrap(~ tema, ncol = 1) + 
  scale_y_sqrt() + 
  scale_x_date(date_labels = "%d-%m-%Y") +
  scale_fill_manual(values = c(cor_agenda_nacional, cor_direitos_humanos, cor_educacao, cor_integridade_transparencia, cor_meio_ambiente)) +
  theme(strip.background = element_blank(), 
                 legend.title = element_blank(),
                 legend.position = "none")

ggplotly(p)

```

Observando o comportamento da temperatura para cada tema acima, podemos perceber que o tema Agenda Nacional tem tido mais atenção por parte do Congresso nos últimos anos, mostrando a força do executivo. Já os outros temas têm tido pouca movimentação, com alguns poucos momentos de crescimento da temperatura.

Podemos verificar alguns picos no histórico da temperatura em cada um dos temas apresentadas anteriormente. 
Vamos analisar os principais picos para cada tema e identificar quais foram as proposições que elevaram a temperatura naquele período.

### Agenda Nacional

```{r, fig.width=12}
temperatura_temas %>% 
  filter(tema == "Agenda Nacional") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_agenda_nacional) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

No gráfico de temperatura por tema acima, podemos identificar, no tema Agenda Nacional, dois picos principais no início de 2017 e de 2019, respectivamente. Abaixo mostramos mais de perto esses picos, numa linha do tempo mais resumida.

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2016-06-01'), 
                tema == "Agenda Nacional") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_agenda_nacional) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```


```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Agenda Nacional",
                     semana = lubridate::ymd(c('2017-02-13')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_an_1 <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_an_1
```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Agenda Nacional",
                     semana = lubridate::ymd(c('2019-05-06')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_an_2 <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_an_2
```

Ao analisarmos os projetos de lei que mais contribuíram para o aumento da temperatura nesses picos observados, percebemos que ambos são PECs de Reforma da Previdência: 

  * em 2017, a do Governo Temer, responsável por `r round(100*(evolucao_semanal_temperatura_an_1$evolucao_temp_recente[1]/sum(evolucao_semanal_temperatura_an_1$evolucao_temp_recente)))`% do aumento na temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_an_1$semana), format="%d/%m/%Y")`)
  * em 2019, a do Governo Bolsonaro, responsável por `r round(100*(evolucao_semanal_temperatura_an_2$evolucao_temp_recente[1]/sum(evolucao_semanal_temperatura_an_2$evolucao_temp_recente)))`% do aumento na temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_an_2$semana), format="%d/%m/%Y")`)

### Direitos Humanos

```{r, fig.width=12}
temperatura_temas %>% 
  filter(tema == "Direitos Humanos") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill = cor_direitos_humanos) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

No tema Direitos Humanos, identificamos um pico no segundo semestre de 2015. Abaixo mostramos mais de perto esse pico, numa linha do tempo mais resumida.

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2015-06-01'),
         semana <= lubridate::ymd('2015-12-31'),
                tema == "Direitos Humanos") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill = cor_direitos_humanos) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Direitos Humanos",
                     semana = lubridate::ymd(c('2015-08-10')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_dh <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_dh
```

O projeto de lei que mais contribuiu para o aumento da temperatura nesse pico observado foi a PEC 18/2011 (que autoriza o trabalho a partir dos 14 anos), responsável por `r round(100*(evolucao_semanal_temperatura_dh$evolucao_temp_recente[1]/sum(evolucao_semanal_temperatura_dh$evolucao_temp_recente)))`% do aumento na temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_dh$semana), format="%d/%m/%Y")`) 

## Educação

```{r, fig.width=12}
temperatura_temas %>% 
  filter(tema == "Educação") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill = cor_educacao) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

Observando a temperatura histórica do tema Educação, é possível perceber um pico no início do ano 2017. Abaixo mostramos mais de perto esse pico, numa linha do tempo mais resumida.

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2016-06-01'),
         semana <= lubridate::ymd('2017-05-31'),
                tema == "Educação") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill = cor_educacao) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Educação",
                     semana = lubridate::ymd(c('2017-02-20')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_ed <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_ed
```

A PEC 15/2015 (que objetiva tornar o FUNDEB permanente) foi o projeto de lei responsável pela totalidade do aumento da temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_ed$semana), format="%d/%m/%Y")`) 

## Integridade e Transparência

```{r, fig.width=12}
temperatura_temas %>% 
  filter(tema == "Integridade e Transparência") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_integridade_transparencia) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

Para o tema Integridade e Transparência, observamos um aumento mais expressivo no primeiro semestre de 2018. Abaixo mostramos mais de perto esse comportamento, numa linha do tempo mais resumida.

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2017-06-01'),
         semana <= lubridate::ymd('2018-05-31'),
                tema == "Integridade e Transparência") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_integridade_transparencia) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Integridade e Transparência",
                     semana = lubridate::ymd(c('2018-04-09')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_it <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_it
```

O PL 1292/1995, também conhecido como PL das Compras Públicas ou Nova Lei de Licitações, foi o projeto de lei responsável pela totalidade do aumento da temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_it$semana), format="%d/%m/%Y")`) 

## Meio Ambiente

```{r, fig.width=12}
temperatura_temas %>% 
  filter(tema == "Meio Ambiente") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_meio_ambiente) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

Finalmente, observando a evolução histórica da temperatura do tema Meio Ambiente, percebemos um pico mais agudo no final do primeiro semestre de 2018. Abaixo mostramos mais de perto esse comportamento, numa linha do tempo mais resumida.

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2018-01-01'),
         semana <= lubridate::ymd('2019-01-01'),
                tema == "Meio Ambiente") %>%
  ggplot(aes(x=semana, y=total_temp)) +
  geom_area(fill=cor_meio_ambiente) +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```

```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Meio Ambiente",
                     semana = lubridate::ymd(c('2018-06-04')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_ma <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

#evolucao_semanal_temperatura_ma
```

O projeto de lei que mais contribuiu para o aumento da temperatura nesse pico observado foi o PL 6670/2016, também conhecido como a Política do Governo de Redução de Agrotóxico, responsável por `r round(100*(evolucao_semanal_temperatura_ma$evolucao_temp_recente[1]/sum(evolucao_semanal_temperatura_ma$evolucao_temp_recente)))`% do aumento na temperatura registrado naquela semana (iniciada em `r format(first(evolucao_semanal_temperatura_ma$semana), format="%d/%m/%Y")`).
