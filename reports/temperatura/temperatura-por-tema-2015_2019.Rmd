---
title: "Análise da Temperatura por Tema"
author: "Equipe Leg.go"
date: "25/05/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
---

Neste relatório, faremos uma análise histórica da Temperatura das proposições agregadas por tema ao longo dos anos.

```{r knitr_init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE, results="asis"}
library(dplyr)
library(magrittr)
library(ggplot2)
library(plotly)

knitr::opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)

min_date <- lubridate::ymd_hms('2015-01-01 00:00:00')
max_date <- lubridate::ymd_hms('2019-05-10 23:59:59')

temperatura_props <- readr::read_csv('../../data/novo_historico_temperatura.csv')
leggo_ids <- readr::read_csv('../../data/leggo_ids.csv')
proposicoes <- readr::read_csv('../../data/proposicoes.csv')

nomes_pls <- proposicoes %>% 
  mutate(nome_pl = paste(sigla_tipo, paste(numero, lubridate::year(data_apresentacao),sep='/'))) %>%
  select(id_ext, nome_pl)

leggo_ids_nomes <- leggo_ids %>%
  inner_join(nomes_pls) %>%
  select(id_leggo, id_ext, nome_pl, everything()) %>%
  group_by(id_leggo) %>%
  summarise(id_ext = paste0(id_ext, collapse = "|"),
            nome_pl = paste0(nome_pl, collapse = "|"),
            apelido = first(apelido),
            tema = first(tema))
  
# 
# temas_props <- proposicoes %>% 
#   mutate(nome_pl = paste(sigla_tipo, paste(numero, lubridate::year(data_apresentacao),sep='/'))) %>%
#   select(id_ext, nome_pl, apelido, tema)

temperatura_props_temas <- temperatura_props %>%
  filter((periodo >= min_date) & (periodo <= max_date)) %>%
  inner_join(leggo_ids_nomes,by = "id_leggo") %>%
  tidyr::separate_rows(tema,sep=';') %>%
  select(id_leggo, tema, nome_pl, apelido, semana = periodo, temperatura_periodo, temperatura_recente) %>%
  arrange(semana,tema,desc(temperatura_recente))

evolucao_semanal_temperatura <- temperatura_props_temas %>%
  group_by(id_leggo) %>%
  arrange(semana) %>%
  mutate(evolucao_temp_recente = temperatura_recente - lag(temperatura_recente, default = 0)) %>%
  ungroup() %>%
  arrange(id_leggo,semana)

temperatura_temas <- temperatura_props_temas %>%
  group_by(tema,semana) %>%
  summarise(num_obs = n(),
            total_temp = sum(temperatura_recente),
            min_temp = min(temperatura_recente),
            max_temp = max(temperatura_recente),
            mean_temp = mean(temperatura_recente),
            median_temp = median(temperatura_recente),
            std_temp = sd(temperatura_recente),
            var_temp = var(temperatura_recente))
```

## Qual foi o comportamento da temperatura geral das proposições acompanhadas pelo Leggo nos últimos anos (2015-2019)?

```{r}

temperatura_geral <- temperatura_props %>%
  filter((periodo >= min_date) & (periodo <= max_date)) %>%
  inner_join(leggo_ids,by = "id_leggo") %>%
  mutate(semana = periodo) %>%
  group_by(semana) %>%
  summarise(total_temp = sum(temperatura_recente))

p <- temperatura_geral %>%
  filter((semana >= lubridate::ymd_hms('2015-01-01 00:00:00')) && (semana <= lubridate::ymd_hms('2018-12-31 23:59:59'))) %>%
  ggplot(aes(x=as.Date(semana), y=total_temp)) +
  geom_col(position="dodge") +
  xlab("Tempo") + 
  ylab("Temperatura") +
  scale_x_date(date_labels = "%d-%m-%Y") +
  theme_minimal()

ggplotly(p)

```

Como podemos perceber, para o nosso sub-conjunto de proposições, a temperatura estava mais baixa em 2015 e 2016, subindo do final de 2016 para o início de 2017. 
Em seguida, houve uma queda e voltou a subir no primeiro semestre de 2018.
No período anterior e durante as eleições houve uma (natural) queda e voltou a subir do final do ano de 2018 até o presente momento (Maio/2019).

Vamos analisar a temperatura por tema para podermos compreender melhor que temas/proposições influcenciaram essas subidas de temperatura observadas.

## Qual foi o comportamento da temperatura de cada tema acompanhado pelo Leggo nos últimos anos (2015-2019)? 

```{r, fig.height=8}
p <- temperatura_temas %>% 
  filter((semana >= lubridate::ymd_hms('2015-01-01 00:00:00')) && (semana <= lubridate::ymd_hms('2018-12-31 23:59:59'))) %>%
  ggplot(aes(x=semana, y=total_temp, fill=tema)) +
  # geom_col() +
  geom_area() +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  facet_wrap(~ tema, ncol = 1) + 
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")

ggplotly(p)

```
Podemos verificar alguns picos no histórico da temparatura em cada um dos temas apresentadas anteriormente. 
Vamos analisar os principais picos para cada tema e identificar quais foram as proposições que elevaram a temperatura naquele período.
<br>

Iniciemos pelo tema Agenda Nacional

```{r, fig.width=8, fig.height=3}
temperatura_temas %>% 
  filter(semana >= lubridate::ymd('2016-06-01'), 
                tema == "Agenda Nacional") %>%
  ggplot(aes(x=semana, y=total_temp, fill=tema)) +
  geom_area() +
  xlab("Tempo") + 
  ylab("Temperatura") +
  theme_minimal() +
  scale_y_sqrt() + 
  theme(strip.background = element_blank(), 
                 legend.position = "None")
```


## Agenda Nacional - Semana de pico: 13/02/2017 
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Agenda Nacional",
                     semana = lubridate::ymd(c('2017-02-13')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```

## Agenda Nacional - Semana de pico: 13/02/2017 
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Agenda Nacional",
                     semana = lubridate::ymd(c('2019-05-06')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```

## Direitos Humanos - Semana de pico: 03/08/2015
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Direitos Humanos",
                     semana = lubridate::ymd(c('2015-08-03')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(temperatura_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(temperatura_recente))

evolucao_semanal_temperatura_tema
```

## Educação - Semana de pico: 20/02/2017 
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Educação",
                     semana = lubridate::ymd(c('2017-02-20')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```

## Integridade e Transparências - Semana de pico: 09/04/2018 
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Integridade e Transparências",
                     semana = lubridate::ymd(c('2018-04-09')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```

## Meio Ambiente - Semana de pico: 04/06/2018 
```{r warning=FALSE, message=FALSE}
semana <- data.frame(tema = "Meio Ambiente",
                     semana = lubridate::ymd(c('2018-06-04')
                                             , tz=lubridate::tz(temperatura_props_temas$semana[1])))
evolucao_semanal_temperatura_tema <- evolucao_semanal_temperatura %>%
  inner_join(semana) %>%
  filter(evolucao_temp_recente > 0) %>%
  select(semana,nome_pl,apelido,temperatura_periodo,temperatura_recente,evolucao_temp_recente) %>%
  arrange(desc(evolucao_temp_recente))

evolucao_semanal_temperatura_tema
```

