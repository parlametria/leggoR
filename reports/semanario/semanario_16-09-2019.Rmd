---
title: "Semanário Leg.go"
author: "Equipe Leg.go"
date: "06/10/2019"
output:
  prettydoc::html_pretty:
    theme: leonids
    highlight: github
params:
  date_init: 2019-09-15
  date_end: 2019-09-19
  num_semanas_passadas: 3
  proposicoes: 
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  temperaturas:
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  pressoes: 
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
  atores:
    label: "Input dataset:"
    value: ../../data/tabela_geral_ids_casa.csv
    input: file
---

```{r knitr_init, echo=FALSE, message=FALSE, warning=FALSE, cache=FALSE, paged.print=FALSE, results="asis"}
library(magrittr)
knitr::opts_chunk$set(echo = FALSE,
	             cache = FALSE,
               prompt = FALSE,
               tidy = FALSE,
               comment = NA,
               message = FALSE,
               warning = FALSE)
```

```{r}
library(tidyverse)
library(here)
library(lubridate)
library(ggplot2)
library(plotly)
library(hrbrthemes)
library(grid)
library(gridExtra)
library(tibble)
install.packages("ggchicklet", repos = "https://cinc.rud.is")
library(ggchicklet)
```

<style>
body {
text-align: justify}
</style>

```{r, message=FALSE, warning=FALSE, include=FALSE}
#Base de dados de temperatura
temperatura <- params$temperaturas
pressao <- params$pressoes
data_inicio <- params$date_init
data_fim <- params$date_end
pls <- params$proposicoes
atores <- params$atores
```


```{r}
#Base de dados de atuações e filtros por data
atores_geral <- atores %>% 
  mutate(partido = if_else(is.na(partido), "-", partido), 
         uf = if_else(is.na(uf), "-", uf),
         nome_completo = paste0(nome_autor, " (",partido,"/",uf,")"))

props <- proposicoes %>% 
  select(id_ext, sigla_tipo, numero, apelido, data_apresentacao, tema) %>% 
  mutate(ano = format(as.Date(data_apresentacao), "%Y"), id_ext = as.numeric(id_ext))


atores_apelidos <-
  atores_geral %>% 
  dplyr::left_join(props, by = 'id_ext') %>% 
  mutate(nome_formal = paste0(sigla_tipo, ' ', numero, '/', as.character(ano))) 

oposicao <- c("PT", "PSOL", "PSB", "PCdoP", "PDT", "REDE")

atores_apelidos <-
  atores_apelidos %>% 
  mutate(bancada = if_else(partido %in% oposicao, "Oposição", "Governo"))

atores_pls <- atores_apelidos %>% 
  dplyr::group_by(id_ext, nome_autor, casa, id_autor, tipo_autor, partido, nome_completo,
           uf, tipo_generico, sigla_local, is_important, bancada, nome_formal, sigla_tipo, tema) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))

atuacao_temas <- atores_pls %>% 
  dplyr::group_by(bancada, tema) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))

atuacao_bancadas <- atores_pls %>% 
  dplyr::group_by(casa, bancada, nome_formal, sigla_tipo) %>% 
  dplyr::summarise(qtd_de_documentos = sum(qtd_de_documentos))

qntd_pec6 <-
  atores_pls %>% 
  filter(nome_formal == 'PEC 6/2019')
```

```{r}
pauta_prop <- function(temperatura_df, pressao_df) {
  temperatura_ <- temperatura_df %>% 
  select(-temperatura_periodo)

  temperatura_$periodo <- as.Date(temperatura_$periodo)

  pressao_ <- pressao_df %>% 
     dplyr::select(id_ext,
          periodo = date,
          casa,
          pressao = maximo_geral) 

  pauta <- dplyr::inner_join(temperatura_, pressao_, by = "periodo")
  return(pauta)
}
```


```{r}
pauta<- pauta_prop(temperatura, pressao)
```

```{r}
sumariza_prop <- function(pauta_df) {
  pauta <- pauta_df %>% 
  dplyr::group_by(periodo) %>% 
  dplyr::summarise(media_temperatura = mean(temperatura_recente),
            max_pressao = max(pressao)) 
  
  return(pauta)
}
```


```{r}
pauta <- sumariza_prop(pauta)

```


```{r}
datas <- as.Date(c("2019-03-04", "2019-05-06", "2019-07-01", "2019-09-02", "2019-10-05"))
```


```{r}
pauta <- pauta %>% 
  mutate(max_pressao = if_else(max_pressao == 0, 2, max_pressao))
```

##Pressão e Temperatura

```{r, fig.height=7, fig.width=10}
data_n_semanas_atras <- as.Date(data_fim) - (7 * num_semanas_passadas)
pauta_das_n_semanas <- pauta %>% filter(periodo >= data_n_semanas_atras)

p <- pauta %>% 
  ggplot(aes(x = periodo, y = sqrt(media_temperatura))) +
  geom_line(color="#DDDDDD") +
  geom_point(color=factor(ifelse(pauta$periodo==data_inicio,"#EF476F","#DDDDDD")),
           size = ifelse(pauta$periodo==data_inicio,3,1),
           width=0.5) +
  geom_col(aes(x = periodo, y = -sqrt(max_pressao), width = 4), fill=factor(ifelse(pauta$periodo==data_inicio,"#FFD166","#DDDDDD")), show.legend = FALSE ) +
  geom_line(data =  pauta_das_n_semanas, aes(x = periodo, y = sqrt(media_temperatura)), color="#EF476F") +
  geom_col(data =  pauta_das_n_semanas, aes(x = periodo, y = -sqrt(max_pressao), width = 4), fill=factor("#FFD166"), show.legend = FALSE ) +
  labs(x = "Semana", 
       y = "",
       title = "Temperatura e pressão ao longo das semanas",
       subtitle = "PEC 6/2019 - Nova previdência") +
  scale_x_date(date_labels = "%d de %b", breaks = datas) +
  theme_ipsum_rc(grid = FALSE) +
  theme(axis.text.y = element_blank(), 
        axis.text.x = element_text(angle = 0, vjust = 0.5)) +
  theme(axis.text.x = element_text(color = "gray60", size = 8)) 
  
grob <- grobTree(textGrob("Temperatura", x=0.1,  y=0.95, hjust=0,
 gp=gpar(col="black", fontsize=10, alpha = 0.3, fontfamily = "Roboto", fontface = "bold")))

grob2 <- grobTree(textGrob("Pressão", x=0.1,  y=.1, hjust=0,
 gp=gpar(col="black", fontsize=10, alpha = 0.3, fontfamily = "Roboto", fontface = "bold")))

p + annotation_custom(grob) + annotation_custom(grob2)


```

```{r}
est_prev <- tail(pauta, 2)
temp_atual <- est_prev$media_temperatura[length(est_prev$media_temperatura)]
ultima_temp <- est_prev$media_temperatura[length(est_prev$media_temperatura) - 1]
variacao_temp <- round(((temp_atual - ultima_temp) / ultima_temp) * 100, digits = 2)
press_atual <- est_prev$max_pressao[length(est_prev$max_pressao)]
ultima_press <- est_prev$max_pressao[length(est_prev$max_pressao) - 1]
variacao_press <- press_atual - ultima_press
cresceu_temp <- variacao_temp > 0
cresceu_press <- variacao_press > 0
variacao_temp <- abs(variacao_temp)
variacao_press <- abs(variacao_press)
```


Foi observad`r if(cresceu_temp){"o um crescimento de "}else{"a uma diminuição de "}` `r variacao_temp`% na temperatura e `r if(cresceu_press){"um crescimento de "}else{ if(variacao_press == 0){"não foi observada nenhuma mudança"}else{"uma diminuição de "}}` `r if(variacao_press != 0){variacao_press}``r if(variacao_press != 0){"%"}` na pressão.

##Atores da semana

```{r, fig.height=6, fig.width=10}
p <- atuacao_temas %>% ggplot(aes(x = reorder(tema, qtd_de_documentos), y = qtd_de_documentos, group = bancada, fill = bancada)) + 
    geom_chicklet(width = 0.75) +
     theme_ipsum_rc(grid=FALSE) +
     theme(legend.position = "bottom") +
     labs(
      x = NULL, y = "Quantidade de documentos", fill = NULL,
      title = "Atuações das bancadas por tema",
      subtitle = "Documentos autorados pelos parlamentares \nna última semana",
      caption = ""
     ) + 
     scale_fill_manual(
     name = NULL,
     values = c(
      "Governo" = "#436f82",
      "Oposição" = "#ae4544"
     )) +
     coord_flip()
p <- p + theme_ipsum_rc(grid=FALSE)
p <- p + theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +theme(axis.text.x = element_text(color = "gray60", size = 10)) +
  theme(legend.position = "top")
p

qtd_tema <-
  atuacao_temas %>% 
  group_by(tema) %>% 
  summarise(total = sum(qtd_de_documentos)) 

tema_destaque <-
  qtd_tema %>% 
  arrange(total) %>% 
  tail(1) %>% 
  purrr::pluck("tema")

total_docs <- sum(qtd_tema$total)
total_tema_destaque <- qtd_tema %>% filter(tema == tema_destaque) %>% purrr::pluck("total")
variacao_temp <- round(((total_tema_destaque * 100) / total_docs), digits = 2)
atuacao_temas_destaque <- atuacao_temas %>% filter(tema == tema_destaque)
pls_tema_destaque <- atores_pls %>%  filter(tema == tema_destaque)
num_docs_governo <- atuacao_temas_destaque %>% filter(bancada == "Governo") %>% purrr::pluck("qtd_de_documentos")
num_docs_oposicao <- atuacao_temas_destaque %>% filter(bancada == "Oposição") %>% purrr::pluck("qtd_de_documentos")
```

Na última semana o tema `r tema_destaque` teve destaque nas atuações parlamentares, sendo `r variacao_temp`% dos documentos autorados para esse tema. Outro destaque é que foram apresentados `r num_docs_governo` documentos pela bancada do governo e `r num_docs_oposicao` pela oposição.

Ao clicar no tema `r tema_destaque`, temos as seguintes proposições tiveram destaque

```{r, fig.height=6, fig.width=10}
p <- atuacao_bancadas %>% filter(nome_formal %in% pls_tema_destaque$nome_formal) %>%  ggplot(aes(x = reorder(nome_formal, qtd_de_documentos), y = qtd_de_documentos, group = bancada, fill = bancada)) + 
    geom_chicklet(width = 0.75) +
     theme_ipsum_rc(grid=FALSE) +
     theme(legend.position = "bottom") +
     labs(
      x = NULL, y = "Quantidade de documentos", fill = NULL,
      title = "Atuações das bancadas por proposição",
      subtitle = "Documentos autorados pelos parlamentares \nna última semana",
      caption = ""
     ) +
     scale_fill_manual(
     name = NULL,
     values = c(
      "Governo" = "#436f82",
      "Oposição" = "#ae4544"
     )) +
     coord_flip()
p <- p + theme_ipsum_rc(grid=FALSE)
p <- p + theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +theme(axis.text.x = element_text(color = "gray60", size = 10)) +
  theme(legend.position = "top")
p

qtd_atuacao <-
  atuacao_bancadas %>% 
  group_by(nome_formal) %>% 
  summarise(total = sum(qtd_de_documentos)) 

prop_destaque <-
  qtd_atuacao %>% 
  arrange(total) %>% 
  tail(1) %>% 
  purrr::pluck("nome_formal")

total_prop_destaque <- qtd_atuacao %>% filter(nome_formal == prop_destaque) %>% purrr::pluck("total")
atuacao_prop_destaque <- atuacao_bancadas %>% filter(nome_formal == prop_destaque)
num_docs_governo <- atuacao_prop_destaque %>% filter(bancada == "Governo") %>% purrr::pluck("qtd_de_documentos")
num_docs_oposicao <- atuacao_prop_destaque %>% filter(bancada == "Oposição") %>% purrr::pluck("qtd_de_documentos")
```

A `r prop_destaque` teve maior número de atuações, com apresentação de `r total_prop_destaque` documentos, sendo `r num_docs_governo` apresentados pelo governo e `r num_docs_oposicao` pela oposição.

Ao clicar na proposição `r prop_destaque` temos mais detalhes sobre os atores e os respectivos documentos apresentados.

```{r, fig.height=8, fig.width=10}
p <- atores_apelidos %>% ggplot(aes(x = reorder(nome_completo, qtd_de_documentos), y = qtd_de_documentos, group = tipo_generico, fill = tipo_generico)) + 
    geom_chicklet(width = 0.8) +
     theme(legend.position = "bottom") +
     labs(
      x = NULL, y = "Quantidade de documentos", fill = NULL,
      title = "Atuações dos parlamentares por proposição",
      subtitle = "Documentos autorados pelos parlamentares \nna última semana",
      caption = ""
     ) +
     scale_fill_manual(
     name = NULL,
     values = c(
        'Emenda' =  '#80B1D3',
        'Parecer'= '#FB9A99',
        'Voto em Separado' ='#855D7C',
        'Requerimento' = '#B2DF8A',
        'Proposição Apensada' ='#F9EE9D',
        'Outros' = '#587B7A'
     )) +
     coord_flip() +
     theme(aspect.ratio = 0.9)
p <- p + theme_ipsum_rc(grid=FALSE)
p <- p + theme(axis.text.x = element_text(angle = 0, vjust = 0.5)) +theme(axis.text.x = element_text(color = "gray60", size = 10)) +
  theme(legend.position = "top")
p

tipo_generico_destaque <-
  atores_apelidos  %>% 
  group_by(tipo_generico) %>% 
  summarise(total = sum(qtd_de_documentos)) %>% 
  arrange(total) %>% 
  tail(1) %>% 
  purrr::pluck("tipo_generico")

```

O documento que os parlamentares mais apresentaram foi: `r tipo_generico_destaque`.

